<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GENESIS Module Test</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Shared Styles -->
    <link rel="stylesheet" href="shared/styles/variables.css">
    <link rel="stylesheet" href="shared/styles/reset.css">
    <link rel="stylesheet" href="shared/styles/typography.css">
    
    <style>
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-primary);
            padding: 20px;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .test-section {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .test-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 15px;
            transition: all var(--transition-base);
        }
        
        .test-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .test-button {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: var(--font-weight-semibold);
            transition: all var(--transition-fast);
            margin: 5px;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
        }
        
        .status.success {
            background: var(--success-bg);
            color: var(--success-color);
        }
        
        .status.error {
            background: var(--error-bg);
            color: var(--error-color);
        }
        
        .status.warning {
            background: var(--warning-bg);
            color: var(--warning-color);
        }
        
        .status.info {
            background: var(--info-bg);
            color: var(--info-color);
        }
        
        #log {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 15px;
            font-family: var(--font-mono);
            font-size: var(--font-size-sm);
            height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid transparent;
        }
        
        .log-entry.success {
            border-left-color: var(--success-color);
            color: var(--success-color);
        }
        
        .log-entry.error {
            border-left-color: var(--error-color);
            color: var(--error-color);
        }
        
        .log-entry.info {
            border-left-color: var(--info-color);
            color: var(--info-color);
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1 class="text-gradient">GENESIS Module System Test</h1>
            <p class="text-secondary">Testing modular architecture components</p>
        </div>
        
        <div class="test-section">
            <h2>Core System</h2>
            <div class="test-grid">
                <div class="test-card">
                    <h3>EventBus</h3>
                    <p class="text-secondary">Event communication system</p>
                    <span class="status info" id="eventbus-status">Not loaded</span>
                </div>
                <div class="test-card">
                    <h3>Store</h3>
                    <p class="text-secondary">Global state management</p>
                    <span class="status info" id="store-status">Not loaded</span>
                </div>
                <div class="test-card">
                    <h3>Router</h3>
                    <p class="text-secondary">Module navigation</p>
                    <span class="status info" id="router-status">Not loaded</span>
                </div>
                <div class="test-card">
                    <h3>Config</h3>
                    <p class="text-secondary">System configuration</p>
                    <span class="status info" id="config-status">Not loaded</span>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>Module Tests</h2>
            <div style="margin-bottom: 20px;">
                <button class="test-button" onclick="testCoreSystem()">Test Core System</button>
                <button class="test-button" onclick="testEventBus()">Test EventBus</button>
                <button class="test-button" onclick="testStore()">Test Store</button>
                <button class="test-button" onclick="testModuleLoading()">Test Module Loading</button>
                <button class="test-button" onclick="clearLog()">Clear Log</button>
            </div>
            
            <div id="module-info" class="test-card" style="display: none;">
                <h3>Loaded Modules</h3>
                <div id="module-list"></div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>Test Log</h2>
            <div id="log"></div>
        </div>
    </div>
    
    <script type="module">
        // Import core components
        import { EventBus } from './core/event-bus.js';
        import { Store } from './core/store.js';
        import { ModuleLoader } from './core/module-loader.js';
        import config from './core/config.js';
        
        // Make them globally available for testing
        window.EventBus = EventBus;
        window.Store = Store;
        window.ModuleLoader = ModuleLoader;
        window.config = config;
        
        // Log function
        window.log = function(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        };
        
        // Test core system
        window.testCoreSystem = async function() {
            log('Starting core system test...', 'info');
            
            try {
                // Test EventBus
                const eventBus = new EventBus();
                if (eventBus) {
                    document.getElementById('eventbus-status').className = 'status success';
                    document.getElementById('eventbus-status').textContent = 'Loaded';
                    log('✅ EventBus loaded successfully', 'success');
                }
                
                // Test Store
                const store = new Store();
                if (store) {
                    document.getElementById('store-status').className = 'status success';
                    document.getElementById('store-status').textContent = 'Loaded';
                    log('✅ Store loaded successfully', 'success');
                }
                
                // Test ModuleLoader
                const moduleLoader = new ModuleLoader(config);
                if (moduleLoader) {
                    document.getElementById('router-status').className = 'status success';
                    document.getElementById('router-status').textContent = 'Loaded';
                    log('✅ ModuleLoader loaded successfully', 'success');
                }
                
                // Test Config
                if (config && config.version) {
                    document.getElementById('config-status').className = 'status success';
                    document.getElementById('config-status').textContent = `v${config.version}`;
                    log(`✅ Config loaded: version ${config.version}`, 'success');
                }
                
                // Make them global for other tests
                window.eventBus = eventBus;
                window.store = store;
                window.moduleLoader = moduleLoader;
                
                log('Core system test completed!', 'success');
                
            } catch (error) {
                log(`❌ Error loading core system: ${error.message}`, 'error');
            }
        };
        
        // Test EventBus
        window.testEventBus = function() {
            if (!window.eventBus) {
                log('❌ EventBus not initialized. Run Core System test first!', 'error');
                return;
            }
            
            log('Testing EventBus...', 'info');
            
            // Test event emission and listening
            let received = false;
            const unsubscribe = window.eventBus.on('test:event', (data) => {
                received = true;
                log(`✅ Event received: ${JSON.stringify(data)}`, 'success');
            });
            
            window.eventBus.emit('test:event', { test: 'data' });
            
            if (received) {
                log('✅ EventBus working correctly', 'success');
            } else {
                log('❌ EventBus failed to deliver event', 'error');
            }
            
            // Clean up
            unsubscribe();
        };
        
        // Test Store
        window.testStore = function() {
            if (!window.store) {
                log('❌ Store not initialized. Run Core System test first!', 'error');
                return;
            }
            
            log('Testing Store...', 'info');
            
            // Test set and get
            window.store.set('test.value', 42);
            const value = window.store.get('test.value');
            
            if (value === 42) {
                log('✅ Store set/get working correctly', 'success');
            } else {
                log('❌ Store set/get failed', 'error');
            }
            
            // Test subscription
            let notified = false;
            const unsubscribe = window.store.subscribe('test.value', (newVal) => {
                notified = true;
                log(`✅ Store notification received: ${newVal}`, 'success');
            });
            
            window.store.set('test.value', 100);
            
            if (notified) {
                log('✅ Store subscriptions working correctly', 'success');
            } else {
                log('❌ Store subscriptions failed', 'error');
            }
            
            // Clean up
            unsubscribe();
        };
        
        // Test module loading
        window.testModuleLoading = async function() {
            if (!window.moduleLoader) {
                log('❌ ModuleLoader not initialized. Run Core System test first!', 'error');
                return;
            }
            
            log('Testing module loading...', 'info');
            
            try {
                // Create a container for the module
                const container = document.createElement('div');
                document.body.appendChild(container);
                
                // Try to load auth module
                log('Attempting to load auth module...', 'info');
                const authModule = await window.moduleLoader.loadModule('auth', container);
                
                if (authModule) {
                    log('✅ Auth module loaded successfully', 'success');
                    
                    // Show module info
                    const moduleInfo = document.getElementById('module-info');
                    moduleInfo.style.display = 'block';
                    
                    const moduleList = document.getElementById('module-list');
                    moduleList.innerHTML = `
                        <p><strong>Name:</strong> ${authModule.name}</p>
                        <p><strong>Version:</strong> ${authModule.version}</p>
                        <p><strong>Dependencies:</strong> ${authModule.dependencies.join(', ') || 'none'}</p>
                    `;
                }
                
                // Clean up
                document.body.removeChild(container);
                
            } catch (error) {
                log(`❌ Module loading failed: ${error.message}`, 'error');
            }
        };
        
        // Clear log
        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
            log('Log cleared', 'info');
        };
        
        // Initial message
        log('Module test system ready. Click buttons to test components.', 'info');
    </script>
</body>
</html>
