<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0b0d12">

  <title>GENESIS 1.1 - Платформа для пассивного и активного дохода в криптовалюте</title>
  <meta name="description" content="Зарабатывайте пассивный и активный доход в интернете с GENESIS 1.1. Депозиты от $25, партнерская программа 3 уровня, MEV-боты с доходностью десятки процентов в сутки.">

  <!-- Favicons -->
  <link rel="icon" href="/public/icons/icon-192.png">
  <link rel="apple-touch-icon" href="/public/icons/icon-192.png">

  <!-- PWA Manifest -->
  <link rel="manifest" href="/public/manifest.json">

  <!-- Styles -->
  <link rel="stylesheet" href="/src/styles/tokens.css">
  <link rel="stylesheet" href="/src/styles/theme-dark.css">

  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "GENESIS 1.1",
    "description": "Платформа для пассивного и активного дохода в криптовалюте",
    "applicationCategory": "FinanceApplication"
  }
  </script>
</head>
<body>
  <!-- Main Container -->
  <main class="container">
    <!-- Hero Section -->
    <section id="hero" style="text-align: center; padding: var(--space-4xl) 0;">
      <h1 id="hero-title">GENESIS 1.1</h1>
      <p style="font-size: var(--font-size-xl); color: var(--text-muted); margin-top: var(--space-lg);">
        Платформа для пассивного и активного дохода в криптовалюте
      </p>
    </section>

    <!-- Features Section -->
    <section id="features" style="padding: var(--space-4xl) 0;">
      <h2 class="section-title">Возможности платформы</h2>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-2xl);">
        <div class="card">
          <h3 class="sub-title">Пассивный доход</h3>
          <ul class="list-bullets">
            <li>Доход от аренды мощностей устройства</li>
            <li>Доход от депозитов с автоматическими выплатами</li>
            <li>Партнерская программа 3 уровня (5% от вложений и дохода)</li>
            <li>Программа лояльности и бонусная система</li>
          </ul>
        </div>

        <div class="card">
          <h3 class="sub-title">Активный доход</h3>
          <ul class="list-bullets">
            <li>MEV-боты с доходностью десятки процентов в сутки</li>
            <li>Арбитражные роботы для мгновенных сделок</li>
            <li>Доход от волатильности PLEX ONE токена</li>
            <li>Активные множители для увеличения прибыли</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Trust Section -->
    <section id="trust" style="padding: var(--space-4xl) 0; text-align: center;">
      <h2 class="section-title">Доверие и безопасность</h2>
      <div id="trust-badges" class="hidden" style="display: flex; gap: var(--space-md); justify-content: center; flex-wrap: wrap; margin-top: var(--space-xl);">
        <span class="chip chip--success">Верификация: подтверждён</span>
        <a id="badgeContract" class="badge" target="_blank" rel="noopener noreferrer">BscScan: Contract</a>
        <a id="badgeRead" class="badge" target="_blank" rel="noopener noreferrer">BscScan: Read</a>
        <a id="badgeWrite" class="badge" target="_blank" rel="noopener noreferrer">BscScan: Write</a>
      </div>
      <p id="trust-message" class="text-muted" style="margin-top: var(--space-lg);">
        Адрес контракта будет доступен после авторизации
      </p>
    </section>

    <!-- Price Chart Section -->
    <section id="price" style="padding: var(--space-4xl) 0;">
      <h2 class="section-title">График цены PLEX ONE</h2>
      <div id="chartWrap" class="card">
        <div id="chart" data-state="idle" style="height: 260px; background: var(--bg-1); border-radius: var(--radius-md);"></div>
        <div class="actions">
          <button id="refreshChart" class="btn btn--ghost">Обновить график</button>
        </div>
      </div>
    </section>

    <!-- Auth Section with Stepper -->
    <section id="auth" style="padding: var(--space-4xl) 0;">
      <h2 class="section-title">Авторизация в системе</h2>

      <ol id="auth-steps" class="stepper">
        <!-- Step 1: Wallet Address -->
        <li data-step="1" class="step is-active">
          <h3 class="sub-title">1) Введите адрес кошелька</h3>
          <div class="field">
            <label for="userAddress">Ваш адрес кошелька (BSC)</label>
            <input
              id="userAddress"
              name="userAddress"
              type="text"
              autocomplete="off"
              inputmode="text"
              placeholder="0x… (42 символа)"
              aria-describedby="userAddressHelp">
            <p id="userAddressHelp" class="help"></p>
          </div>
          <div class="actions">
            <button id="step1Next" class="btn btn--primary" disabled>Далее</button>
          </div>
        </li>

        <!-- Step 2: Payment -->
        <li data-step="2" class="step">
          <h3 class="sub-title">2) Оплата / депозит</h3>
          <div class="card">
            <div class="qr" id="system-qr">
              <p class="text-muted">QR-код появится после первого шага</p>
            </div>
            <div class="addr">
              <code id="systemAddress" data-contract-address="">Адрес для оплаты появится здесь</code>
              <button id="copySystemAddress" class="btn btn--ghost" disabled>Скопировать адрес</button>
            </div>
            <p class="note">
              Переведите указанную сумму на адрес выше. После отправки транзакции нажмите «Проверить оплату».
            </p>
            <div class="actions">
              <button id="checkPayment" class="btn btn--primary" data-rate-limit="15" disabled>
                Проверить оплату
              </button>
              <span class="hint">Лимит: не чаще 1 раза в 15 сек (экономим RPC)</span>
            </div>
          </div>
          <div class="actions">
            <button id="step2Back" class="btn">Назад</button>
            <button id="step2Next" class="btn btn--primary" disabled>Далее</button>
          </div>
        </li>

        <!-- Step 3: Verification -->
        <li data-step="3" class="step">
          <h3 class="sub-title">3) Проверка транзакции</h3>
          <div id="paymentStatus" class="chip chip--processing">Ожидание проверки…</div>
          <p class="text-muted" style="margin-top: var(--space-lg);">
            Проверяем получение платежа в блокчейне. Это может занять несколько минут.
          </p>
          <div class="actions">
            <button id="recheckPayment" class="btn btn--ghost">Проверить ещё раз</button>
            <button id="step3Next" class="btn btn--primary" disabled>Далее</button>
          </div>
        </li>

        <!-- Step 4: Complete -->
        <li data-step="4" class="step">
          <h3 class="sub-title">4) Готово!</h3>
          <p style="font-size: var(--font-size-lg); color: var(--success);">
            ✅ Авторизация подтверждена. Добро пожаловать в GENESIS 1.1!
          </p>
          <p class="text-muted" style="margin-top: var(--space-md);">
            Теперь вы можете перейти в личный кабинет и начать зарабатывать.
          </p>
          <div class="actions">
            <a href="/cabinet" class="btn btn--primary">Открыть кабинет</a>
          </div>
        </li>
      </ol>
    </section>

    <!-- Technical Info Section -->
    <section id="tech-panel" style="padding: var(--space-4xl) 0;">
      <h2 class="section-title">Техническая информация</h2>
      <div class="card">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-lg);">
          <div>
            <div class="text-muted" style="font-size: var(--font-size-sm);">Браузер</div>
            <div id="tech-browser" class="skeleton" style="height: 20px; margin-top: var(--space-xs);"></div>
          </div>
          <div>
            <div class="text-muted" style="font-size: var(--font-size-sm);">Язык</div>
            <div id="tech-lang" class="skeleton" style="height: 20px; margin-top: var(--space-xs);"></div>
          </div>
          <div>
            <div class="text-muted" style="font-size: var(--font-size-sm);">Часовой пояс</div>
            <div id="tech-timezone" class="skeleton" style="height: 20px; margin-top: var(--space-xs);"></div>
          </div>
          <div>
            <div class="text-muted" style="font-size: var(--font-size-sm);">Соединение</div>
            <div id="tech-connection" class="skeleton" style="height: 20px; margin-top: var(--space-xs);"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer style="padding: var(--space-4xl) 0; text-align: center; border-top: 1px solid var(--border-color); margin-top: var(--space-4xl);">
      <p class="text-muted" style="font-size: var(--font-size-sm);">
        © 2025 GENESIS 1.1. Все права защищены.
      </p>
    </footer>
  </main>

  <!-- Scripts -->
  <script type="module">
    import { isHexAddressBSC, debounce, normalizeAddress } from '/src/js/validators.js';
    import { copy, setupCopyButton } from '/src/js/clipboard.js';
    import { showToast, initStepper, setActiveStep, nextStep, prevStep, setStepState, setLoading, showSkeleton, hideSkeleton } from '/src/js/ui.js';
    import { initChart, generateMockData } from '/src/js/chart.js';
    import { initPWA } from '/src/js/pwa.js';

    // ===== GLOBALS =====
    let chart = null;
    let lastPaymentCheck = 0;
    const RATE_LIMIT_MS = 15000; // 15 секунд

    // ===== INIT =====
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('🚀 GENESIS 1.1 initializing...');

      // Init PWA
      await initPWA();

      // Init Stepper
      initStepper('auth-steps');

      // Init Chart
      chart = initChart(document.getElementById('chart'));

      // Init Event Listeners
      setupEventListeners();

      // Fill Technical Info
      fillTechInfo();

      console.log('✅ GENESIS 1.1 initialized');
    });

    // ===== EVENT LISTENERS =====
    function setupEventListeners() {
      // Step 1: Address validation
      const userAddressInput = document.getElementById('userAddress');
      const step1NextBtn = document.getElementById('step1Next');

      userAddressInput.addEventListener('input', debounce((e) => {
        validateAddress(e.target.value);
      }, 500));

      step1NextBtn.addEventListener('click', () => {
        const address = normalizeAddress(userAddressInput.value);
        if (isHexAddressBSC(address)) {
          proceedToPayment(address);
        }
      });

      // Step 2: Payment
      document.getElementById('step2Back').addEventListener('click', () => prevStep());
      document.getElementById('step2Next').addEventListener('click', () => nextStep());

      const checkPaymentBtn = document.getElementById('checkPayment');
      checkPaymentBtn.addEventListener('click', () => checkPayment());

      // Step 3: Verification
      document.getElementById('recheckPayment').addEventListener('click', () => recheckPayment());
      document.getElementById('step3Next').addEventListener('click', () => nextStep());

      // Chart refresh
      document.getElementById('refreshChart').addEventListener('click', () => refreshChart());

      // Copy system address
      setupCopyButton(
        document.getElementById('copySystemAddress'),
        () => document.getElementById('systemAddress').textContent
      );
    }

    // ===== ADDRESS VALIDATION =====
    function validateAddress(address) {
      const helpEl = document.getElementById('userAddressHelp');
      const inputEl = document.getElementById('userAddress');
      const nextBtn = document.getElementById('step1Next');

      if (!address || address.length === 0) {
        helpEl.textContent = '';
        helpEl.className = 'help';
        inputEl.classList.remove('is-valid', 'is-invalid');
        nextBtn.disabled = true;
        return;
      }

      const normalized = normalizeAddress(address);

      if (isHexAddressBSC(normalized)) {
        helpEl.textContent = '✓ Адрес корректен';
        helpEl.className = 'help is-success';
        inputEl.classList.add('is-valid');
        inputEl.classList.remove('is-invalid');
        nextBtn.disabled = false;
      } else {
        helpEl.textContent = '✗ Неверный формат адреса (ожидается 0x… 42 символа)';
        helpEl.className = 'help is-error';
        inputEl.classList.add('is-invalid');
        inputEl.classList.remove('is-valid');
        nextBtn.disabled = true;
      }
    }

    // ===== PROCEED TO PAYMENT =====
    function proceedToPayment(userAddress) {
      // Симуляция: генерируем системный адрес для оплаты
      const systemAddress = '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb3'; // Example address

      // Показываем адрес
      const systemAddressEl = document.getElementById('systemAddress');
      systemAddressEl.textContent = systemAddress;
      systemAddressEl.dataset.contractAddress = systemAddress;

      // Включаем кнопку копирования
      document.getElementById('copySystemAddress').disabled = false;
      document.getElementById('checkPayment').disabled = false;

      // Генерируем QR код
      const qrContainer = document.getElementById('system-qr');
      qrContainer.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${systemAddress}" alt="QR Code" style="max-width: 200px;">`;

      // Показываем бейджи BscScan
      showTrustBadges(systemAddress);

      // Переходим к шагу 2
      nextStep();

      showToast('Адрес для оплаты сгенерирован', 'success');
    }

    // ===== TRUST BADGES =====
    function showTrustBadges(contractAddress) {
      if (!isHexAddressBSC(contractAddress)) {
        return;
      }

      const badgesContainer = document.getElementById('trust-badges');
      const messageEl = document.getElementById('trust-message');

      // Формируем ссылки
      document.getElementById('badgeContract').href = `https://bscscan.com/token/${contractAddress}`;
      document.getElementById('badgeRead').href = `https://bscscan.com/token/${contractAddress}#readContract`;
      document.getElementById('badgeWrite').href = `https://bscscan.com/token/${contractAddress}#writeContract`;

      // Показываем бейджи
      badgesContainer.classList.remove('hidden');
      messageEl.classList.add('hidden');
    }

    // ===== CHECK PAYMENT =====
    async function checkPayment() {
      const now = Date.now();
      const timeSinceLastCheck = now - lastPaymentCheck;

      if (timeSinceLastCheck < RATE_LIMIT_MS) {
        const remainingSeconds = Math.ceil((RATE_LIMIT_MS - timeSinceLastCheck) / 1000);
        showToast(`Подождите ${remainingSeconds} сек перед следующей проверкой`, 'warn');
        return;
      }

      lastPaymentCheck = now;
      const btn = document.getElementById('checkPayment');
      setLoading(btn, true);

      console.info('[pay-check]', {
        time: new Date().toISOString(),
        fromCache: false
      });

      // Симуляция проверки (2 секунды)
      await new Promise(resolve => setTimeout(resolve, 2000));

      setLoading(btn, false);

      // Для демо: рандомный успех
      const success = Math.random() > 0.5;

      if (success) {
        showToast('Оплата подтверждена!', 'success');
        document.getElementById('step2Next').disabled = false;
        setStepState(2, 'success');
      } else {
        showToast('Оплата пока не найдена. Попробуйте позже.', 'error');
        setStepState(2, 'error');
      }
    }

    // ===== RECHECK PAYMENT =====
    async function recheckPayment() {
      // Аналогично checkPayment
      await checkPayment();

      // Если успешно, разрешаем переход к шагу 4
      document.getElementById('step3Next').disabled = false;
      document.getElementById('paymentStatus').className = 'chip chip--success';
      document.getElementById('paymentStatus').textContent = 'Транзакция подтверждена ✓';
    }

    // ===== CHART =====
    function refreshChart() {
      if (!chart) return;

      const btn = document.getElementById('refreshChart');
      setLoading(btn, true);

      // Симуляция загрузки данных
      setTimeout(() => {
        const mockData = generateMockData(50);
        chart.setData(mockData);
        setLoading(btn, false);
        showToast('График обновлён', 'success');
      }, 1000);
    }

    // ===== TECH INFO =====
    function fillTechInfo() {
      // Показываем скелетоны пока загружаемся
      setTimeout(() => {
        const browserEl = document.getElementById('tech-browser');
        const langEl = document.getElementById('tech-lang');
        const timezoneEl = document.getElementById('tech-timezone');
        const connectionEl = document.getElementById('tech-connection');

        // Заполняем реальными данными
        browserEl.textContent = navigator.userAgent.split(' ').slice(-2).join(' ');
        hideSkeleton(browserEl);

        langEl.textContent = navigator.language || navigator.userLanguage || 'N/A';
        hideSkeleton(langEl);

        try {
          const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
          timezoneEl.textContent = tz || 'N/A';
        } catch {
          timezoneEl.textContent = 'N/A';
        }
        hideSkeleton(timezoneEl);

        if (navigator.connection) {
          const conn = navigator.connection;
          connectionEl.textContent = `${conn.effectiveType || 'N/A'} (${conn.downlink || '?'} Mbps)`;
        } else {
          connectionEl.textContent = 'Online';
        }
        hideSkeleton(connectionEl);
      }, 1500);
    }
  </script>
</body>
</html>
